<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件共享 - WEB笔记系统</title>
    <style>
            /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* 导航栏样式 */
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            margin-right: 20px;
        }
        
        .nav ul {
            display: flex;
            list-style: none;
            flex-wrap: wrap;
        }
        
        .nav ul li {
            margin: 0 10px;
        }
        
        .nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        .nav ul li a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .search-box {
            display: flex;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .search-box input {
            border: none;
            padding: 10px 15px;
            outline: none;
            width: 200px;
        }
        
        .search-box button {
            border: none;
            background: #ff6b6b;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-box button:hover {
            background: #ee5a5a;
        }
        
        /* 文件共享页面特定样式 */
        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .files-header h1 {
            color: #2c3e50;
            font-size: 28px;
        }
        
        .upload-btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        .file-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active, .filter-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .file-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-5px);
        }
        
        .file-icon {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            font-size: 48px;
        }
        .file-icon.txt { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); }
        .file-icon.pdf { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); }
        .file-icon.docx { background: linear-gradient(135deg, #3498db 0%, #5dade2 100%); }
        .file-icon.xlsx { background: linear-gradient(135deg, #2ecc71 0%, #58d68d 100%); }
        .file-icon.jpg { background: linear-gradient(135deg, #9b59b6 0%, #bb8fce 100%); }
        .file-icon.zip { background: linear-gradient(135deg, #f39c12 0%, #f8c471 100%); }
        .file-icon.exe { background: linear-gradient(135deg, #7f8c8d 0%, #b2babb 100%); }
        
        .file-info {
            padding: 20px;
        }
        
        .file-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-meta {
            display: flex;
            justify-content: space-between;
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .download-btn {
            flex: 1;
            background: #3498db;
            color: white;
            text-align: center;
            padding: 8px 0;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.3s ease;
        }
        
        .download-btn:hover {
            background: #2980b9;
        }
        
        .preview-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            background: #f1f1f1;
            color: #7f8c8d;
            border-radius: 5px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .preview-btn:hover {
            background: #e0e0e0;
        }
        
        /* 页脚样式 */
        .footer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 40px 0 20px;
            margin-top: 40px;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-section {
            flex: 1;
            min-width: 250px;
        }
        
        .footer-section h3 {
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 10px;
        }
        
        .footer-section ul li a {
            color: #bdc3c7;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-section ul li a:hover {
            color: #3498db;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
        }
        
        .social-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #34495e;
            color: white;
            border-radius: 50%;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .social-links a:hover {
            background: #3498db;
            transform: translateY(-3px);
        }
        
        .subscribe-form {
            display: flex;
            margin-top: 15px;
        }
        
        .subscribe-form input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px 0 0 5px;
            outline: none;
        }
        
        .subscribe-form button {
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .subscribe-form button:hover {
            background: #2980b9;
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #34495e;
            color: #bdc3c7;
        }
        
        /* 响应式设计 */
        @media (max-width: 900px) {
            .header .container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav ul {
                margin: 15px 0;
                justify-content: center;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .files-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 600px) {
            .nav ul {
                flex-direction: column;
                align-items: center;
            }
            
            .nav ul li {
                margin: 5px 0;
            }
            
            .footer-content {
                flex-direction: column;
            }
            
            .files-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
          .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.dragover {
            background-color: #f8f9fa;
            border-color: #2980b9;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .selected-files {
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            color: #7f8c8d;
            margin: 0 10px;
        }
        
        .remove-file {
            color: #e74c3c;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }
        
        .upload-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .upload-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .cancel-btn {
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .cancel-btn:hover {
            background-color: #c0392b;
        }
        
        .upload-submit-btn {
            padding: 10px 20px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-submit-btn:hover {
            background-color: #27ae60;
        }
        
        .upload-submit-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1100;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        /* 上传历史 */
        .upload-history {
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-file-icon {
            color: #3498db;
        }

    </style>
    <!-- 使用CDN加载Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- 导航栏 -->
    <header class="header">
        <div class="container">
            <a href="/" class="logo">WEB笔记系统</a>

            <nav class="nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/create-note">创建笔记</a></li>
                    <li><a href="/create-article">创建文章</a></li>
                    <li><a href="/create-directory">创建目录</a></li>
                    <li><a href="/files">文件共享</a></li>
                </ul>
            </nav>

            <div class="search-box">
                <input type="text" placeholder="搜索文件..." id="fileSearch">
                <button><i class="fas fa-search"></i></button>
            </div>
        </div>
    </header>

    <!-- 文件共享内容区 -->
    <div class="container">
        <div class="files-header">
            <h1><i class="fas fa-folder-open"></i> 文件共享中心</h1>
            <a href="#" class="upload-btn" id="openUploadModal">
                <i class="fas fa-cloud-upload-alt"></i> 上传文件
            </a>
        </div>
        
        <div class="file-filters">
            <button class="filter-btn active" data-filter="all">全部文件</button>
            <button class="filter-btn" data-filter="document">文档</button>
            <button class="filter-btn" data-filter="image">图片</button>
            <button class="filter-btn" data-filter="archive">压缩包</button>
            <button class="filter-btn" data-filter="executable">应用程序</button>
        </div>
       
<div class="files-grid">
        {%for f in filelist%}
<div class="file-card" data-type="{{f["data-type"]}}">
                <div class="{{f["extension"]}}">
                    <i class="{{f["icon"]}}"></i>
                </div>
                <div class="file-info">
                    <h3>{{f["file-name"]}}</h3>
                    <div class="file-meta">
                        <span>{{f["size"]}}</span>
                        <span>{{f["date"]}}</span>
                    </div>
                    <div class="file-actions">
                        <a href={{f["path"]}} class="download-btn">下载</a>
                        <a href={{f["path"]}} class="preview-btn" target="_blank">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            </div>

{%endfor%}
  </div>

    <!-- 上传文件模态框 -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>上传文件</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            
            <div class="upload-area" id="dropArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p>拖放文件到此处，或<strong>点击选择文件</strong></p>
                <p class="small">支持多文件上传，单个文件最大 10GB，超过100MB采取分片上传</p>
                <input type="file" id="fileInput" class="file-input" multiple>
            </div>
            
            <div class="selected-files" id="selectedFiles">
                <!-- 选择的文件将在这里显示 -->
            </div>
            
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            
            <div class="upload-actions">
                <button class="cancel-btn" id="cancelUpload">取消</button>
                <button class="upload-submit-btn" id="startUpload" disabled>
                    <i class="fas fa-upload"></i> 开始上传
                </button>
            </div>
        </div>
    </div>

    <!-- 通知消息 -->
    <div class="notification" id="notification">
        <span id="notificationMessage"></span>
    </div>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>快速链接</h3>
                    <ul>
                        <li><a href="/">首页</a></li>
                        <li><a href="/about">关于我</a></li>
                        <li><a href="/files">文件共享</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>社交媒体</h3>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-qq"></i></a>
                        <a href="#"><i class="fab fa-github"></i></a>
                        <a href="#"><i class="fas fa-envelope"></i></a>
                        <a href="#"><i class="fab fa-weixin"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>申请账户</h3>
                    <p>申请账户，创建属于自己的笔记系统</p>
                    <form class="subscribe-form">
                        <input type="email" placeholder="您的邮箱地址">
                        <button type="submit">申请</button>
                    </form>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 WEB笔记系统. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 文件搜索和上传功能
document.addEventListener('DOMContentLoaded', function() {
    const searchButton = document.querySelector('.search-box button');
    const searchInput = document.getElementById('fileSearch');
    const fileCards = document.querySelectorAll('.file-card');
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // 搜索功能
    searchButton.addEventListener('click', filterFiles);
    searchInput.addEventListener('keyup', filterFiles);
    
    // 文件类型过滤
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // 更新活动按钮状态
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // 过滤文件
            fileCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    if (card.getAttribute('data-type') === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });
    });
    
    function filterFiles() {
        const searchTerm = searchInput.value.toLowerCase();
        
        fileCards.forEach(card => {
            const fileName = card.querySelector('h3').textContent.toLowerCase();
            if (fileName.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // 订阅表单处理
    const subscribeForm = document.querySelector('.subscribe-form');
    if (subscribeForm) {
        subscribeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const emailInput = this.querySelector('input[type="email"]');
            const email = emailInput.value.trim();
            
            if (email && isValidEmail(email)) {
                alert(`感谢订阅! 我们将发送更新到: ${email}`);
                emailInput.value = '';
            } else {
                alert('请输入有效的邮箱地址');
            }
        });
    }
    
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // 文件上传功能
    const modal = document.getElementById('uploadModal');
    const openModalBtn = document.getElementById('openUploadModal');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelUploadBtn = document.getElementById('cancelUpload');
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const selectedFilesContainer = document.getElementById('selectedFiles');
    const startUploadBtn = document.getElementById('startUpload');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notificationMessage');
    
    let selectedFiles = [];
    let uploadInProgress = false;
    
    // 打开模态框
    openModalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    });
    
    // 关闭模态框
    function closeModal() {
        if (!uploadInProgress) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
            resetUploadForm();
        } else {
            showNotification('请先完成或取消当前上传', 'error');
        }
    }
    
    closeModalBtn.addEventListener('click', closeModal);
    cancelUploadBtn.addEventListener('click', closeModal);
    
    // 点击模态框背景关闭
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // 点击drop区域触发文件选择
    dropArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // 拖放功能
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('dragover');
    }
    
    function unhighlight() {
        dropArea.classList.remove('dragover');
    }
    
    // 处理文件拖放
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    // 处理文件选择
    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });
    
    // 处理选择的文件
    function handleFiles(files) {
        if (uploadInProgress) {
            showNotification('请先完成当前上传', 'error');
            return;
        }
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 检查文件大小
            if (file.size > 10*1024 * 1024 * 1024) {
                showNotification(`文件 "${file.name}" 超过10GB限制`, 'error');
                continue;
            }
            
            // 检查是否已选择相同文件
            if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                selectedFiles.push(file);
            }
        }
        
        updateSelectedFilesList();
        updateUploadButton();
    }
    
    // 更新选择的文件列表
    function updateSelectedFilesList() {
        selectedFilesContainer.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            selectedFilesContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">暂无选择文件</p>';
            return;
        }
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileSize = formatFileSize(file.size);
            
            fileItem.innerHTML = `
                <span class="file-name">${file.name}</span>
                <span class="file-size">${fileSize}</span>
                <button class="remove-file" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            selectedFilesContainer.appendChild(fileItem);
        });
        
        // 添加移除文件的事件监听
        document.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                selectedFiles.splice(index, 1);
                updateSelectedFilesList();
                updateUploadButton();
            });
        });
    }
    
    // 更新上传按钮状态
    function updateUploadButton() {
        startUploadBtn.disabled = selectedFiles.length === 0;
    }
    
    // 开始上传
    startUploadBtn.addEventListener('click', startUpload);
    
    function startUpload() {
        if (selectedFiles.length === 0 || uploadInProgress) return;
        
        uploadInProgress = true;
        startUploadBtn.disabled = true;
        cancelUploadBtn.textContent = '取消上传';
        uploadProgress.style.display = 'block';
        
        let uploadedCount = 0;
        const totalFiles = selectedFiles.length;
        
        const uploadNextFile = () => {
            if (uploadedCount >= totalFiles) {
                uploadComplete();
                return;
            }
            
            const file = selectedFiles[uploadedCount];
            const progress = ((uploadedCount / totalFiles) * 100).toFixed(0);
            
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `上传中 (${uploadedCount + 1}/${totalFiles}) ${progress}%`;
            
            // 实际文件上传
            if (file.size < (100 * 1024 * 1024)) {
                // 小文件直接上传
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/uploads', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('上传失败');
                    }
                    return response.json();
                })
                .then(data => {
                    uploadedCount++;
                    uploadNextFile();
                })
                .catch(error => {
                    console.error('上传错误:', error);
                    showNotification(`上传失败: ${file.name}`, 'error');
                    uploadedCount++;
                    uploadNextFile();
                });
            } else {
                // 大文件分片上传
                uploadLargeFile(file)
                    .then(() => {
                        uploadedCount++;
                        uploadNextFile();
                    })
                    .catch(error => {
                        console.error('分片上传错误:', error);
                        showNotification(`分片上传失败: ${file.name}`, 'error');
                        uploadedCount++;
                        uploadNextFile();
                    });
            }
        };
        
        // 开始上传第一个文件
        uploadNextFile();
    }
    
    // 大文件分片上传函数
    async function uploadLargeFile(file) {
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB/分片
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        const filename = file.name;
        
        try {
            // 检查已上传分片
            const checkForm = new FormData();
            checkForm.append("filename", filename);
            checkForm.append("total_chunks", totalChunks);
            
            const checkResponse = await fetch("/upload/check", {
                method: "POST",
                body: checkForm
            });
            
            if (!checkResponse.ok) {
                throw new Error('检查分片失败');
            }
            
            const { completed_chunks = [] } = await checkResponse.json();
            const completedSet = new Set(completed_chunks);
            
            // 上传缺失的分片
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                if (completedSet.has(chunkIndex)) continue;
                
                const start = chunkIndex * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                
                const chunkFormData = new FormData();
                chunkFormData.append("file", chunk);
                chunkFormData.append("filename", filename);
                chunkFormData.append("chunk_index", chunkIndex);
                chunkFormData.append("total_chunks", totalChunks);
                
                const chunkResponse = await fetch("/upload/chunk", {
                    method: "POST",
                    body: chunkFormData
                });
                
                if (!chunkResponse.ok) {
                    throw new Error(`分片 ${chunkIndex} 上传失败`);
                }
            }
            
            // 合并分片
            const mergeFormData = new FormData();
            mergeFormData.append("filename", filename);
            mergeFormData.append("total_chunks", totalChunks);
            
            const mergeResponse = await fetch("/upload/merge", {
                method: "POST",
                body: mergeFormData
            });
            
            if (!mergeResponse.ok) {
                throw new Error('合并分片失败');
            }
            
            return await mergeResponse.json();
        } catch (error) {
            console.error('大文件上传错误:', error);
            throw error;
        }
    }
    
    // 上传完成
    function uploadComplete() {
        uploadInProgress = false;
        progressFill.style.width = '100%';
        progressText.textContent = '上传完成!';
        
        // 显示成功通知
        showNotification(`成功上传 ${selectedFiles.length} 个文件`, 'success');
        
        // 添加到上传历史
        addToUploadHistory(selectedFiles);
        
        // 3秒后关闭模态框
        setTimeout(() => {
            closeModal();
            
            // 在实际应用中，这里可以刷新文件列表
            window.location.reload();
        }, 3000);
    }
    
    // 重置上传表单
    function resetUploadForm() {
        selectedFiles = [];
        uploadInProgress = false;
        startUploadBtn.disabled = true;
        cancelUploadBtn.textContent = '取消';
        uploadProgress.style.display = 'none';
        progressFill.style.width = '0%';
        progressText.textContent = '0%';
        updateSelectedFilesList();
    }
    
    // 显示通知
    function showNotification(message, type) {
        notification.className = `notification ${type}`;
        notificationMessage.textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // 添加上传历史
    function addToUploadHistory(files) {
        const historyList = document.getElementById('uploadHistoryList');
        if (!historyList) return;
        
        files.forEach(file => {
            const fileSize = formatFileSize(file.size);
            const fileExtension = file.name.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file';
            
            if (['pdf'].includes(fileExtension)) fileIcon = 'fa-file-pdf';
            else if (['doc', 'docx'].includes(fileExtension)) fileIcon = 'fa-file-word';
            else if (['xls', 'xlsx'].includes(fileExtension)) fileIcon = 'fa-file-excel';
            else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) fileIcon = 'fa-file-image';
            else if (['zip', 'rar', '7z'].includes(fileExtension)) fileIcon = 'fa-file-archive';
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-file-info">
                    <span class="history-file-icon"><i class="fas ${fileIcon}"></i></span>
                    <span>${file.name}</span>
                </div>
                <span class="file-size">${fileSize}</span>
            `;
            
            historyList.insertBefore(historyItem, historyList.firstChild);
        });
    }
    
    // 清空上传历史
    const clearHistoryBtn = document.getElementById('clearHistory');
    if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const historyList = document.getElementById('uploadHistoryList');
            if (historyList) {
                historyList.innerHTML = '';
            }
        });
    }
    
    // 辅助函数：格式化文件大小
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }
});
    </script>
</body>
</html>